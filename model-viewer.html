<!DOCTYPE html>
<html lang="jp">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>3D Model Viewer</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
    
    <link rel="stylesheet" href="modelviewer_style.css">
    <link rel="stylesheet" href="https://use.typekit.net/zfi8dmc.css">
    
    <style>
        /* Styles for touch/interaction optimization */
        #controls, label, button, .glass, .dim { touch-action: manipulation; }
        .hideDim { font: normal 12pt Arial; font-weight: 500; color: white; pointer-events: auto; border-radius: 115px; }
        
        /* Styles for full-screen overlay/iframe handling */
        body.no-scroll { overflow: hidden; position: fixed; width: 100%; height: 100%; top: 0; left: 0; }

        #iframeWrapper {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            display: none; /* Mantido oculto por padrÃ£o */
            flex-direction: column; overflow-y: auto;
            -webkit-overflow-scrolling: touch; z-index: 9999;
            justify-content: center; align-items: center;
        }

        #iframeWrapper iframe {
            width: 85vw; height: 71vh; max-width: 546px;
            background-color: white; border: 1px solid #ccc;
            border-radius: 8px; overflow-y: auto;
        }
        
        /* Oculta o overlay de specs por padrÃ£o (se nÃ£o for feito via class externa) */
        .spec-overlay { display: none; }
    </style>
</head>

<body>
    <model-viewer ar id="modelViewer"
            shadow-intensity="1"
            shadow-softness="1"
            camera-controls
            camera-orbit="0deg 75deg 3m"
            min-camera-orbit="auto auto 1m"
            max-camera-orbit="auto auto 10m"
            min-field-of-view="10deg"
            max-field-of-view="45deg"
            orbit-sensitivity="2"
            exposure="1.4"
            touch-action="none"
            ar-modes="webxr scene-viewer quick-look"
            animation-name="Action"
            scale="1 1 1"
            autoplay>
        
        <img id="ar-button" src="icon/arbtn.png" slot="ar-button" alt="arbtn">
        <div id="controls">
            </div>
    </model-viewer>

    <div id="buttonsGRP">
        <a href="newMenu.html">
            </a>

        <a id="stampButtonLink">
            <img class="specification" src="icon/buttonMyStamp.png" alt="Stamp Button" id="stampButtonImage">
        </a>

        <a id="controlsLink">
            </a>
    </div>

    <div id="arOverlay" class="ar-overlay">
        <div class="loadingText">
            </div>
    </div>

    <div class="spec-overlay" id="specOverlay">
        <h2>è£½å“ä»•æ§˜</h2>

        <p>ãƒ»æ¦‚è¦ é€†å††éŒå‹ã®ã‚±ãƒ¼ã‚·ãƒ³ã‚°å†…ã§å›è»¢ã™ã‚‹ãƒ‘ãƒ‰ãƒ«ã«ã‚ˆã£ã¦ ç²‰ä½“ã«å¼·åŠ›ãªè¡æ’ƒãƒ»ã›ã‚“æ–­åŠ›ã‚’ä¸ãˆã€æ”ªæ‹Œãƒ»åˆ†æ•£ã—ã€ ç²¾å¯†æ··åˆã‚’è¡Œã†ãƒãƒƒãƒå¼ã®é«˜é€Ÿã›ã‚“æ–­å‹æ··åˆæ©Ÿã§ã™ã€‚ ãƒ»ç‰¹é•· çŸ­ã„æ™‚é–“ã§å‡ä¸€ãªæ··åˆãŒå¯èƒ½</p>

        <a id="modelLink" href="#" target="_blank">è£½å“ä»•æ§˜</a>

        <div id="iframeWrapper">
            <button id="closeIframeBtn">Ã—</button>
            <iframe title="model" id="modelIframe"></iframe>
        </div>

        <img src="icon/returnbtn.png" class="return1" id="closeSpec">
        <br><br>
    </div>

<script type="module">
        // =========================================================================
        // 1. ğŸŒŸ IMPORTS E CONFIGURAÃ‡ÃƒO FIREBASE
        // =========================================================================
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"; // Importa onAuthStateChanged
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”‘ SUA CONFIGURAÃ‡ÃƒO FIREBASE (DEVE SER IDÃŠNTICA AOS OUTROS SCRIPTS)
        const firebaseConfig = {
             apiKey: "AIzaSyAM88d_Qu-_FFDf-NF7Ckk0eYYYKAZA3pU",
             authDomain: "stamp-edfc5.firebaseapp.com",
             projectId: "stamp-edfc5",
             storageBucket: "stamp-edfc5.firebasestorage.app",
             messagingSenderId: "522739532414",
             appId: "1:522739532414:web:047e4168251b5542ce8e2f",
             measurementId: "G-2EVLH3GZNS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 

        // -------------------------------------------------------------------------
        // 2. ğŸ’¾ FUNÃ‡ÃƒO DE BANCO DE DADOS (ESCRITA): Adiciona o carimbo
        // -------------------------------------------------------------------------

        async function addStampToFirebase(uid, modelName) {
            if (!uid) {
                console.error("UIDãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                return;
            }
            
            try {
                const docRef = doc(db, "users", uid);
                const docSnap = await getDoc(docRef);
                let currentStamps = [];

                if (docSnap.exists()) {
                    currentStamps = docSnap.data().stamps || [];
                }

                // Adiciona o novo carimbo se ele ainda nÃ£o estiver na lista
                if (!currentStamps.includes(modelName)) {
                    currentStamps.push(modelName);
                    // Usa updateDoc para adicionar o novo array ao documento do usuÃ¡rio
                    await updateDoc(docRef, {
                        stamps: currentStamps
                    });
                    console.log(`Carimbo '${modelName}' salvo no Firebase para o usuÃ¡rio ${uid}.`);
                } else {
                    console.log(`Carimbo '${modelName}' jÃ¡ existe no Firebase.`);
                }

            } catch (error) {
                console.error("Firebase ã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜ã™ã‚‹éš›ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
            }
        }

        // =========================================================================
        // 3. VARIÃVEIS, INICIALIZAÃ‡ÃƒO E LÃ“GICA EXISTENTE
        // =========================================================================
        
        // 3.1. VariÃ¡veis e Seletores
        const urlParams = new URLSearchParams(window.location.search);
        const modelUrl = urlParams.get('model');
        const modelViewer = document.getElementById('modelViewer');
        const arButton = document.getElementById('ar-button');
        const arOverlay = document.getElementById('arOverlay');
        const specOverlay = document.getElementById('specOverlay');
        const stampButtonLink = document.getElementById('stampButtonLink');
        const closeSpec = document.getElementById('closeSpec');
        const iframeWrapper = document.getElementById('iframeWrapper');
        const modelIframe = document.getElementById('modelIframe');
        const closeIframeBtn = document.getElementById('closeIframeBtn');
        const controlsLink = document.getElementById('controlsLink');

        let modelKey = "";
        
        // 3.2. InicializaÃ§Ã£o do Modelo e ModelKey
        if (modelUrl) {
            modelViewer.setAttribute('src', modelUrl);
            // Extrai a chave do modelo (ex: 'model1')
            modelKey = modelUrl.split('/').pop().split('.')[0]; 
        }

        // ----------------------------------------------------
        // ğŸš¨ CORREÃ‡ÃƒO 1: OUVINTE DE ESTADO DE AUTENTICAÃ‡ÃƒO E SEGURANÃ‡A
        // Garante que se o usuÃ¡rio nÃ£o estiver logado, ele Ã© enviado para index.html (login)
        // e a URL do modelo Ã© salva para retorno.
        // ----------------------------------------------------

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // UsuÃ¡rio NÃƒO estÃ¡ logado.
                console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ä¿å­˜å…ˆã‚’ä¿å­˜ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚");
                
                // Salva a URL completa do modelo para redirecionar apÃ³s o login.
                localStorage.setItem('redirectAfterLogin', window.location.href);

                // Redireciona para o Index (Login)
                window.location.href = 'index.html'; 
            } else {
                // UsuÃ¡rio estÃ¡ logado. Remove o item de redirecionamento (caso exista) 
                // para que o app.js nÃ£o tente redirecionar apÃ³s o prÃ³ximo login.
                localStorage.removeItem('redirectAfterLogin'); 
            }
        });


        // -------------------------------------------------------------------------
        // 4. ğŸ¯ LÃ“GICA DE CONQUISTA DO CARIMBO (IMPLEMENTAÃ‡ÃƒO FIREBASE)
        // -------------------------------------------------------------------------
        
        // O botÃ£o com a imagem stamp.png tem o ID 'stampButtonLink'
        stampButtonLink.addEventListener('click', async (event) => {
            event.preventDefault(); // Impede a aÃ§Ã£o padrÃ£o

            if (!modelKey) {
                 console.error("ãƒ¢ãƒ‡ãƒ«ã‚­ãƒ¼ï¼ˆmodelKeyï¼‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¿å­˜ã§ãã¾ã›ã‚“ã€‚");
                 return;
            }

            const user = auth.currentUser; // ObtÃ©m o usuÃ¡rio logado

            if (user) {
                // USUÃRIO LOGADO: Salva o carimbo no Firebase
                await addStampToFirebase(user.uid, modelKey); 
                console.log(`Carimbo salvo no Firestore para o modelo: ${modelKey}`);
                
            } else {
                // Caso o status Auth mude entre a carga da pÃ¡gina e o clique do botÃ£o
                alert("ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é›†ã‚ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚");
                localStorage.setItem('redirectAfterLogin', window.location.href);
                window.location.href = 'index.html';
                return;
            }

            // Sempre redireciona para a pÃ¡gina do menu (newMenu.html) apÃ³s tentar salvar
            window.location.href = `newMenu.html?newStamp=${encodeURIComponent(modelKey)}`;
        });

        // -------------------------------------------------------------------------
        // 5. LÃ“GICA DE SOBREPOSIÃ‡ÃƒO DE ESPECIFICAÃ‡Ã•ES (MANTIDA)
        // -------------------------------------------------------------------------
        
        closeSpec.addEventListener('click', () => {
            specOverlay.style.display = 'none';
            iframeWrapper.style.display = 'none';
            modelIframe.src = "";
        });

        closeIframeBtn.addEventListener('click', () => {
            iframeWrapper.style.display = 'none';
            modelIframe.src = '';
        });
        
        // -------------------------------------------------------------------------
        // 6. LÃ“GICA DE ATIVAÃ‡ÃƒO DO AR E EVENTOS (MANTIDA)
        // -------------------------------------------------------------------------

        let arJustStarted = false;
        let arTimeout = null;

        function startAR() {
            arOverlay.style.display = 'none';
            arJustStarted = false;
            modelViewer.activateAR();
        }

        arButton.addEventListener('click', (event) => {
            if (!modelViewer.canActivateAR) {
                console.log("ãƒ‡ãƒã‚¤ã‚¹/ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ AR ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }

            if (!arJustStarted) {
                event.preventDefault();
                event.stopPropagation();

                arOverlay.style.display = 'flex';
                arJustStarted = true;
                arTimeout = setTimeout(startAR, 2000);
            }
        });

        arOverlay.addEventListener('click', () => {
            if (arJustStarted) {
                clearTimeout(arTimeout);
                startAR();
            }
        });

        modelViewer.addEventListener('ar-status', (event) => {
            const status = event.detail.status;
            if (status === 'presenting') {
                modelViewer.play({ animationName: 'action' });
                console.log("ForÃ§ando animaÃ§Ã£o 'action' no modo AR.");
            }
            if (status === 'not-presenting' || status === 'failed') {
                arOverlay.style.display = 'none';
                arJustStarted = false;
                clearTimeout(arTimeout);
            }
            
            // LÃ³gica de ajuste de cÃ¢mera e AR Shadow DOM (mantida)
            const shadowRoot = modelViewer.shadowRoot;
            if (shadowRoot) {
                const internalArButton = shadowRoot.querySelector('button[slot="ar-button"]');
                if (internalArButton) {
                    internalArButton.style.display = (status === 'presenting') ? 'none' : '';
                }
            }
        });

        modelViewer.addEventListener('load', () => {
            const size = modelViewer.getDimensions();
            const maxDim = Math.max(size.x, size.y, size.z);
            const suggestedDistance = maxDim * 1.5;
            modelViewer.cameraOrbit = `0deg 75deg ${suggestedDistance}m`;
        });
                
    </script>
    
    <script>
        // FunÃ§Ãµes para controle de scroll e iframe (nÃ£o modulares)
        function showModel10() {
            const iframeWrapper = document.getElementById('iframeWrapper');
            iframeWrapper.style.display = 'flex';
            document.body.classList.add('no-scroll');
        }

        function hideIframe() {
            const iframeWrapper = document.getElementById('iframeWrapper');
            iframeWrapper.style.display = 'none';
            document.body.classList.remove('no-scroll');
        }
    </script>
</body>
</html>